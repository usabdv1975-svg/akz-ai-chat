import streamlit as st
import anthropic
import os
from pathlib import Path

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(
    page_title="–ê–ö–ó –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç",
    page_icon="üé®",
    layout="wide"
)

# –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
@st.cache_data
def load_knowledge_base():
    knowledge_path = Path(__file__).parent / "knowledge.txt"
    if knowledge_path.exists():
        with open(knowledge_path, 'r', encoding='utf-8') as f:
            return f.read()
    return ""

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–≥–µ–Ω—Ç–∞
SYSTEM_PROMPT = """–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –∞–Ω—Ç–∏–∫–æ—Ä—Ä–æ–∑–∏–π–Ω–æ–π –∑–∞—â–∏—Ç–µ (–ê–ö–ó) –º–µ—Ç–∞–ª–ª–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.
–¢–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –æ–ø—ã—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –∏–∑ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞.

–¢–≤–æ—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –≤–∫–ª—é—á–∞–µ—Ç:
- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏: –ø–µ—Å–∫–æ—Å—Ç—Ä—É–π–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (Sa2, Sa2.5, Sa3), –æ–±–µ–∑–∂–∏—Ä–∏–≤–∞–Ω–∏–µ, –æ–±–µ—Å–ø—ã–ª–∏–≤–∞–Ω–∏–µ
- –õ–∞–∫–æ–∫—Ä–∞—Å–æ—á–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã: –≥—Ä—É–Ω—Ç–æ–≤–∫–∏ (—ç–ø–æ–∫—Å–∏–¥–Ω—ã–µ, —Ü–∏–Ω–∫–æ–Ω–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ), —ç–º–∞–ª–∏ (–ø–æ–ª–∏—É—Ä–µ—Ç–∞–Ω–æ–≤—ã–µ, –∞–ª–∫–∏–¥–Ω—ã–µ), —Ñ–∏–Ω–∏—à–Ω—ã–µ –ø–æ–∫—Ä—ã—Ç–∏—è
- –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: –ø–µ—Å–∫–æ—Å—Ç—Ä—É–π–Ω—ã–µ –∞–ø–ø–∞—Ä–∞—Ç—ã, –∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä—ã, –±–µ–∑–≤–æ–∑–¥—É—à–Ω–æ–µ —Ä–∞—Å–ø—ã–ª–µ–Ω–∏–µ, —Å–æ–ø–ª–∞
- –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –≤–ª–∞–∂–Ω–æ—Å—Ç—å, —Ç–æ—á–∫–∞ —Ä–æ—Å—ã, –º–µ–∂—Å–ª–æ–π–Ω–∞—è —Å—É—à–∫–∞, —Ç–æ–ª—â–∏–Ω–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
- –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã: ISO 8501, –ì–û–°–¢, –°–ù–∏–ü –ø–æ –∑–∞—â–∏—Ç–µ –æ—Ç –∫–æ—Ä—Ä–æ–∑–∏–∏
- –û–≥–Ω–µ–∑–∞—â–∏—Ç–Ω—ã–µ –ø–æ–∫—Ä—ã—Ç–∏—è –∏ —Å–æ—Å—Ç–∞–≤—ã
- –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è

–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –î–∞–≤–∞–π –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –æ–ø—ã—Ç–µ.
–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ ‚Äî —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –∏ –ø—Ä–µ–¥–ª–æ–∂–∏, –≥–¥–µ –º–æ–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

–í–æ—Ç –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –æ–±—Å—É–∂–¥–µ–Ω–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –ø–æ –ê–ö–ó:

{knowledge}
"""

def get_claude_response(client, messages, knowledge):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Claude API"""
    system = SYSTEM_PROMPT.format(knowledge=knowledge[:50000])  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

    response = client.messages.create(
        model="claude-sonnet-4-20250514",
        max_tokens=2048,
        system=system,
        messages=messages
    )

    return response.content[0].text

def main():
    st.title("üé® –ê–ö–ó –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç")
    st.markdown("*–≠–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω—Ç–∏–∫–æ—Ä—Ä–æ–∑–∏–π–Ω–æ–π –∑–∞—â–∏—Ç–µ –º–µ—Ç–∞–ª–ª–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π*")

    # API –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (Railway) –∏–ª–∏ Secrets (Streamlit Cloud)
    api_key = os.environ.get("ANTHROPIC_API_KEY") or st.secrets.get("ANTHROPIC_API_KEY", "")

    # –°–∞–π–¥–±–∞—Ä —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
    with st.sidebar:
        st.header("‚ÑπÔ∏è –û –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–µ")

        st.markdown("""
        –≠—Ç–æ—Ç AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –æ–±—É—á–µ–Ω –Ω–∞ –±–∞–∑–µ **18 000+ —Å–æ–æ–±—â–µ–Ω–∏–π**
        –∏–∑ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –ø–æ –ê–ö–ó.

        **–ú–æ–≥—É –ø–æ–º–æ—á—å —Å:**
        - –í—ã–±–æ—Ä —Å–∏—Å—Ç–µ–º—ã –ø–æ–∫—Ä—ã—Ç–∏—è
        - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
        - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        - –†–µ—à–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º
        - –†–∞—Å—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤

        üåê [ATI1.SU](https://ati1.su)
        """)

        if st.button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é"):
            st.session_state.messages = []
            st.rerun()

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
    knowledge = load_knowledge_base()

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
    if "messages" not in st.session_state:
        st.session_state.messages = []

    # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # –ü–æ–ª–µ –≤–≤–æ–¥–∞
    if prompt := st.chat_input("–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –ê–ö–ó..."):

        # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç Claude
        with st.chat_message("assistant"):
            with st.spinner("–î—É–º–∞—é..."):
                try:
                    client = anthropic.Anthropic(api_key=api_key)

                    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è API
                    api_messages = [
                        {"role": m["role"], "content": m["content"]}
                        for m in st.session_state.messages
                    ]

                    response = get_claude_response(client, api_messages, knowledge)
                    st.markdown(response)

                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
                    st.session_state.messages.append({"role": "assistant", "content": response})

                except anthropic.APIError as e:
                    st.error(f"–û—à–∏–±–∫–∞ API: {e}")
                except Exception as e:
                    st.error(f"–û—à–∏–±–∫–∞: {e}")

    # –ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if not st.session_state.messages:
        st.markdown("### üí° –ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:")

        col1, col2 = st.columns(2)

        with col1:
            if st.button("–ö–∞–∫—É—é —Å–∏—Å—Ç–µ–º—É –ø–æ–∫—Ä—ã—Ç–∏—è –≤—ã–±—Ä–∞—Ç—å –¥–ª—è –º–µ—Ç–∞–ª–ª–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π?"):
                st.session_state.messages.append({
                    "role": "user",
                    "content": "–ö–∞–∫—É—é —Å–∏—Å—Ç–µ–º—É –ø–æ–∫—Ä—ã—Ç–∏—è –≤—ã–±—Ä–∞—Ç—å –¥–ª—è –º–µ—Ç–∞–ª–ª–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –Ω–∞ —É–ª–∏—Ü–µ?"
                })
                st.rerun()

            if st.button("–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å?"):
                st.session_state.messages.append({
                    "role": "user",
                    "content": "–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫—É—é –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ –ø–æ–∫—Ä–∞—Å–∫–æ–π?"
                })
                st.rerun()

        with col2:
            if st.button("–ß—Ç–æ —Ç–∞–∫–æ–µ —Å—Ç–µ–ø–µ–Ω—å –æ—á–∏—Å—Ç–∫–∏ Sa2.5?"):
                st.session_state.messages.append({
                    "role": "user",
                    "content": "–ß—Ç–æ —Ç–∞–∫–æ–µ —Å—Ç–µ–ø–µ–Ω—å –æ—á–∏—Å—Ç–∫–∏ Sa2.5 –∏ –∫–æ–≥–¥–∞ –æ–Ω–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è?"
                })
                st.rerun()

            if st.button("–ö–∞–∫–æ–π —Ä–∞—Å—Ö–æ–¥ –≥—Ä—É–Ω—Ç–∞ –Ω–∞ –º2?"):
                st.session_state.messages.append({
                    "role": "user",
                    "content": "–ö–∞–∫–æ–π —Ä–∞—Å—Ö–æ–¥ —ç–ø–æ–∫—Å–∏–¥–Ω–æ–≥–æ –≥—Ä—É–Ω—Ç–∞ –Ω–∞ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –º–µ—Ç—Ä?"
                })
                st.rerun()

if __name__ == "__main__":
    main()
